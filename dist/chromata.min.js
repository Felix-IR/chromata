"use strict";var _prototypeProperties=function(t,e,i){e&&Object.defineProperties(t,e),i&&Object.defineProperties(t.prototype,i)},Chromata=function(){function t(t){var e,i,n=this,r=void 0===arguments[1]?{}:arguments[1],o=document.createElement("canvas"),s=o.getContext("2d"),a=document.createElement("canvas"),h=a.getContext("2d"),u=new Image;this.options={pathFinderCount:r.pathFinderCount||1,origin:r.origin||["bottom"],speed:r.speed||3,turningAngle:r.turningAngle||Math.PI,colorMode:r.colorMode||"color",lineWidth:r.lineWidth||2,lineMode:r.lineMode||"smooth",compositeOperation:r.compositeOperation||"lighten",outputSize:r.outputSize||"original"},u.src=t.src,e=t.parentNode,this.loader=new Promise(function(r){u.addEventListener("load",function(){i=n._getOutputDimensions(t),a.width=o.width=i.width,a.height=o.height=i.height,h.drawImage(u,0,0,i.width,i.height),t.style.display="none",e.insertBefore(o,t.nextSibling),n.dimensions=i,n.imageArray=n._getImageArray(h),n.workingArray=n._getWorkingArray(h),r()})}),this.imageArray=[],this.sourceContext=h,this.renderContext=s,this.image=u,this.isRunning=!1,this.iterationCount=0}return _prototypeProperties(t,null,{start:{value:function(){var t=this;this.loader.then(function(){t.isRunning=!0,"undefined"==typeof t._tick?t._run():t._tick()})},writable:!0,enumerable:!0,configurable:!0},stop:{value:function(){return this.isRunning=!1,this.iterationCount},writable:!0,enumerable:!0,configurable:!0},toggle:{value:function(){return this.isRunning?this.stop():this.start()},writable:!0,enumerable:!0,configurable:!0},reset:{value:function(){this.isRunning=!1,this._tick=void 0,cancelAnimationFrame(this.raf),this.renderContext.clearRect(0,0,this.dimensions.width,this.dimensions.height),this.workingArray=this._getWorkingArray(this.sourceContext)},writable:!0,enumerable:!0,configurable:!0},_run:{value:function(){var t=this,e=[],i=this._initPathFinders(),n={colorMode:this.options.colorMode,lineWidth:this.options.lineWidth,lineMode:this.options.lineMode,speed:this.options.speed};this.renderContext.globalCompositeOperation=this.options.compositeOperation,i.forEach(function(i){e.push(new PathRenderer(t.renderContext,i,n))}),this._tick=function(){e.forEach(function(t){return t.drawNextLine()}),t.iterationCount++,t.isRunning&&(t.raf=requestAnimationFrame(t._tick))},this._tick()},writable:!0,enumerable:!0,configurable:!0},_initPathFinders:{value:function(){var t=this,e=[],i=this.options.pathFinderCount,n=this.options.origin,r=i/n.length,o={speed:this.options.speed,turningAngle:this.options.turningAngle};return-1<n.indexOf("bottom")&&this._seedBottom(r,e,o),-1<n.indexOf("top")&&this._seedTop(r,e,o),-1<n.indexOf("left")&&this._seedLeft(r,e,o),-1<n.indexOf("right")&&this._seedRight(r,e,o),n.forEach(function(i){var n=i.match(/(\d{1,3})% (\d{1,3})%/);n&&t._seedPoint(r,e,o,n[1],n[2])}),e},writable:!0,enumerable:!0,configurable:!0},_seedTop:{value:function(t,e,i){var n=this,r=this.dimensions.width,o=r/t,s=function(t){return o*t-o/2},a=function(){return n.options.speed};i.startingVelocity=[0,this.options.speed],this._seedCreateLoop(t,e,s,a,i)},writable:!0,enumerable:!0,configurable:!0},_seedBottom:{value:function(t,e,i){var n=this,r=this.dimensions.width,o=this.dimensions.height,s=r/t,a=function(t){return s*t-s/2},h=function(){return o-n.options.speed};i.startingVelocity=[0,-this.options.speed],this._seedCreateLoop(t,e,a,h,i)},writable:!0,enumerable:!0,configurable:!0},_seedLeft:{value:function(t,e,i){var n=this,r=this.dimensions.height,o=r/t,s=function(){return n.options.speed},a=function(t){return o*t-o/2};i.startingVelocity=[this.options.speed,0],this._seedCreateLoop(t,e,s,a,i)},writable:!0,enumerable:!0,configurable:!0},_seedRight:{value:function(t,e,i){var n=this,r=this.dimensions.width,o=this.dimensions.height,s=o/t,a=function(){return r-n.options.speed},h=function(t){return s*t-s/2};i.startingVelocity=[-this.options.speed,0],this._seedCreateLoop(t,e,a,h,i)},writable:!0,enumerable:!0,configurable:!0},_seedPoint:{value:function(t,e,i,n,r){for(var o=Math.floor(this.dimensions.width*n/100),s=Math.floor(this.dimensions.width*r/100),a=1;t+1>a;a++){var h=this._indexToRgbString(a),u=a%4;switch(u){case 0:i.startingVelocity=[-this.options.speed,0];break;case 1:i.startingVelocity=[0,this.options.speed];break;case 2:i.startingVelocity=[this.options.speed,0];break;case 3:i.startingVelocity=[0,-this.options.speed]}e.push(new PathFinder(this.imageArray,this.workingArray,h,o,s,i))}},writable:!0,enumerable:!0,configurable:!0},_seedCreateLoop:{value:function(t,e,i,n,r){for(var o=1;t+1>o;o++){var s=this._indexToRgbString(o),a=i(o),h=n(o);e.push(new PathFinder(this.imageArray,this.workingArray,s,a,h,r))}},writable:!0,enumerable:!0,configurable:!0},_indexToRgbString:{value:function(t){var e;return e=t%3===0?"#0000ff":t%2===0?"#00ff00":"#ff0000"},writable:!0,enumerable:!0,configurable:!0},_getImageArray:{value:function(t){for(var e=t.canvas.width,i=t.canvas.height,n=t.getImageData(0,0,e,i),r=[],o=0;i>o;o++){r.push([]);for(var s=0;e>s;s++){for(var a=[],h=o*e*4+4*s,u=0;4>u;u++)a[u]=n.data[h+u];r[o].push(a)}}return r},writable:!0,enumerable:!0,configurable:!0},_getWorkingArray:{value:function(t){for(var e=t.canvas.width,i=t.canvas.height,n=[],r=0;i>r;r++){n.push([]);for(var o=0;e>o;o++)n[r].push([!1,!1,!1])}return n},writable:!0,enumerable:!0,configurable:!0},_getOutputDimensions:{value:function(t){var e,i;if("original"===this.options.outputSize)e=t.width,i=t.height;else{var n=t.parentNode,r=n.clientWidth/t.width,o=n.clientHeight/t.height,s=r>=o?o:r;e=t.width*s,i=t.height*s}return{width:e,height:i}},writable:!0,enumerable:!0,configurable:!0}}),t}(),MAX=255,PathFinder=function(){function t(t,e,i){var n=void 0===arguments[3]?0:arguments[3],r=void 0===arguments[4]?0:arguments[4],o=void 0===arguments[5]?{}:arguments[5];this.pixelArray=t,this.workingArray=e,this.arrayWidth=t[0].length,this.arrayHeight=t.length,this.x=Math.round(n),this.y=Math.round(r),this.options=o,this.pathQueue=new PathQueue(10),this.velocity=o.startingVelocity,this.targetColor="string"==typeof i?this._hexToRgb(i):i,this.rgbIndex=this._getRgbIndex(this.targetColor)}return _prototypeProperties(t,null,{getNextPoint:{value:function(){var t,e=0,i=5;do t=this._getNextPixel(),e++;while(i>=e&&t.isPristine===!1);return t.nextPixel},writable:!0,enumerable:!0,configurable:!0},_getNextPixel:{value:function(){for(var t,e,i,n=this._getVelocityAngle(),r=1e6,o=this.options.turningAngle,s=Math.round(Math.sqrt(Math.pow(this.velocity[0],2)+Math.pow(this.velocity[1],2))),a=4,h=n-o/2,u=-a/2;n+o/2>=h;h+=o/a,u++){var l=this.x+Math.round(s*Math.cos(h)),c=this.y+Math.round(s*Math.sin(h)),g=MAX;if(this._isInRange(l,c)){var d=this.workingArray[c][l][this.rgbIndex],f=this.pixelArray[c][l],p=f[3];g=this._getColorDistance(f),g>0&&r>g&&!d&&p===MAX&&(e=[l,c,MAX-g],r=g)}0===u&&(i=this.pixelArray[c][l][3]===MAX?[l,c,MAX-g]:this.pathQueue.get(-2))}return t="undefined"!=typeof e,e=e||i,this.velocity=[e[0]-this.x,e[1]-this.y],this.y=e[1],this.x=e[0],this._updateWorkingArray(e[1],e[0]),this.pathQueue.put(e),{nextPixel:e,isPristine:t}},writable:!0,enumerable:!0,configurable:!0},getColor:{value:function(){return{r:this.targetColor[0],g:this.targetColor[1],b:this.targetColor[2]}},writable:!0,enumerable:!0,configurable:!0},_getVelocityAngle:{value:function(){var t,e=this.x+this.velocity[0],i=this.y+this.velocity[1],n=this.options.speed;if(n>=e)t=0;else if(this.arrayWidth-n<=e)t=Math.PI;else if(n>=i)t=Math.PI/2;else if(this.arrayHeight-n<=i)t=1.5*Math.PI;else{var r=this.y+this.velocity[1]-this.y,o=this.x+this.velocity[0]-this.x;t=Math.atan2(r,o)}return t},writable:!0,enumerable:!0,configurable:!0},_hexToRgb:{value:function(t){var e=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;t=t.replace(e,function(t,e,i,n){return e+e+i+i+n+n});var i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return i?[parseInt(i[1],16),parseInt(i[2],16),parseInt(i[3],16)]:null},writable:!0,enumerable:!0,configurable:!0},_getColorDistance:{value:function(t){return MAX-t[this.rgbIndex]},writable:!0,enumerable:!0,configurable:!0},_isInRange:{value:function(t,e){return t>0&&t<this.arrayWidth&&e>0&&e<this.arrayHeight},writable:!0,enumerable:!0,configurable:!0},_updateWorkingArray:{value:function(t,e){this.workingArray[t][e][this.rgbIndex]=!0},writable:!0,enumerable:!0,configurable:!0},_getRgbIndex:{value:function(t){var e;for(e=0;2>e&&0===t[e];e++);return e},writable:!0,enumerable:!0,configurable:!0}}),t}(),PathQueue=function(){function t(t){this.queue=[],this.size=t}return _prototypeProperties(t,null,{put:{value:function(t){this.queue.push(t),this.size<this.queue.length&&this.queue.shift()},writable:!0,enumerable:!0,configurable:!0},get:{value:function(){var t=void 0===arguments[0]?0:arguments[0],e=this.queue.length;return t>=0&&e>=t?this.queue[t]:0>t&&Math.abs(t)<=e?this.queue[e+t]:void 0},writable:!0,enumerable:!0,configurable:!0},contains:{value:function(t){var e=this.queue.filter(function(e){return e[0]===t[0]&&e[1]===t[1]});return 0<e.length},writable:!0,enumerable:!0,configurable:!0}}),t}(),PathRenderer=function(){function t(t,e,i){this.context=t,this.pathFinder=e,this.options=i,this.color=e.getColor()}return _prototypeProperties(t,null,{drawNextLine:{value:function(){"smooth"===this.options.lineMode?this._drawLineSmooth():this._drawLineSquare()},writable:!0,enumerable:!0,configurable:!0},_drawLineSmooth:{value:function(){var t,e,i,n,r=this.pathFinder.getNextPoint(this.context);if("undefined"==typeof this.currentPoint&&(this.currentPoint=r),"undefined"==typeof this.controlPoint&&(this.controlPoint=r),t=Math.round((this.controlPoint[0]+r[0])/2),e=Math.round((this.controlPoint[1]+r[1])/2),i=Math.floor((this.currentPoint[2]+r[2])/2),n=this._getLineLength(this.currentPoint,r),n<=3*this.options.speed){var o=void 0,s=this.currentPoint[2],a=r[2];o=this._createGradient(this.currentPoint,r,s,a),this.context.strokeStyle=o,this.context.lineWidth=this.options.lineWidth,this.context.lineCap="round",this.context.beginPath(),this.context.moveTo(this.currentPoint[0],this.currentPoint[1]),this.context.quadraticCurveTo(this.controlPoint[0],this.controlPoint[1],t,e),this.context.stroke()}this.currentPoint=[t,e,i],this.controlPoint=r},writable:!0,enumerable:!0,configurable:!0},_drawLineSquare:{value:function(){var t,e=this.pathFinder.getNextPoint(this.context);if("undefined"==typeof this.currentPoint&&(this.currentPoint=e),t=this._getLineLength(this.currentPoint,e),t<=this.options.speed+1){var i=void 0,n=this.currentPoint[2],r=e[2];i=this._createGradient(this.currentPoint,e,n,r),this.context.strokeStyle=i,this.context.lineWidth=this.options.lineWidth,this.context.lineCap="round",this.context.beginPath(),this.context.moveTo(this.currentPoint[0],this.currentPoint[1]),this.context.lineTo(e[0],e[1]),this.context.stroke()}this.currentPoint=e},writable:!0,enumerable:!0,configurable:!0},_getLineLength:{value:function(t,e){var i=e[0]-t[0],n=e[1]-t[1];return Math.round(Math.sqrt(i*i+n*n))},writable:!0,enumerable:!0,configurable:!0},_createGradient:{value:function(t,e,i,n){var r=this.context.createLinearGradient(t[0],t[1],e[0],e[1]);return r.addColorStop(0,this._getStrokeColor(i)),r.addColorStop(1,this._getStrokeColor(n)),r},writable:!0,enumerable:!0,configurable:!0},_getStrokeColor:{value:function(t){var e;return e="color"===this.options.colorMode?"rgba("+(0!==this.color.r?t:0)+", "+(0!==this.color.g?t:0)+", "+(0!==this.color.b?t:0)+", 1)":"rgba("+t+", "+t+", "+t+", 1)"},writable:!0,enumerable:!0,configurable:!0}}),t}();